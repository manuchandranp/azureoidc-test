steps:
- task: JfrogCliV2@1
  name: jfrogSetup
  inputs:
    jfrogPlatformConnection: 'hts2'
    command: 'jf rt ping'

- task: Bash@3
  displayName: 'Download via Curl'
  env:
    # Ensure this matches the 'name' of your JfrogCliV2 task
    JF_TOKEN: $(jfrogSetup.oidc_token) 
  inputs:
    targetType: 'inline'
    script: |
      # Debug: Check if token is empty (prints length only for security)
      echo "Token length: ${#JF_TOKEN}"
      
      if [ ${#JF_TOKEN} -le 10 ]; then
        echo "Error: JF_TOKEN appears to be empty or too short. Check OIDC connection."
        exit 1
      fi

      echo "Starting download..."
      # Using -v (verbose) can help see if the Authorization header is actually sent
      curl -fL -H "Authorization: Bearer $JF_TOKEN" \
           "https://your-company.jfrog.io/artifactory/my-repo/my-file.zip" \
           --output "$(Build.ArtifactStagingDirectory)/my-file.zip"
           
      echo "Download complete."

- task: PowerShell@2
  inputs:
    targetType: 'inline'
    script: |
      echo "OIDC Username: $($jfStep.oidc_user)"
      echo "OIDC Token: $jfrogSetup:oidc_token"